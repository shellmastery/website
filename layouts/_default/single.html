{{ define "main" }}
<article class="course-page" data-product-id="{{ .Params.product_id }}">
  <div class="course-header">
    <img src="/img/logos/{{ .Params.logo }}" alt="{{ .Title }}" class="course-logo">
    <div>
      <h2>{{ .Title }}</h2>
      <p>{{ .Description }}</p>
      <p><strong>Price: ${{ .Params.price }}</strong></p>
    </div>
  </div>

  {{ if (isset .Params "description") }}
  <div class="terminal-window">
    <span class="terminal-text">{{ .Params.description }}</span>
  </div>
  {{ end }}

  <div class="course-details">
    {{ .Content }}
  </div>

  <!-- Week Selection & Enrollment Section -->
  <div class="enrollment-section">
    <h3>Select Your Course Dates</h3>
    <div class="week-selector-container">
      <div class="week-selector loading">
        <div class="loading-text">Loading available dates...</div>
      </div>
    </div>

    <div class="enrollment-form" style="display: none;">
      <div class="form-group">
        <label for="student-name">Your Name</label>
        <input type="text" id="student-name" placeholder="Jack Bauer" required>
      </div>
      <div class="form-group">
        <label for="student-email">Your Email</label>
        <input type="email" id="student-email" placeholder="jack@example.com" required>
      </div>
      <button class="buy-button enroll-button" disabled>Select a Week to Continue</button>
    </div>

    <div class="enrollment-error" style="display: none;"></div>
  </div>
</article>

<script>
(function() {
  const API_BASE = 'https://api.shitchell.com/v1';
  const productId = document.querySelector('.course-page').dataset.productId;

  if (!productId) {
    console.error('No product_id found for this course');
    return;
  }

  const weekSelector = document.querySelector('.week-selector');
  const enrollmentForm = document.querySelector('.enrollment-form');
  const enrollButton = document.querySelector('.enroll-button');
  const errorDiv = document.querySelector('.enrollment-error');

  let selectedWeek = null;
  let reservationToken = null;

  // Fetch available weeks
  async function loadAvailableWeeks() {
    try {
      const response = await fetch(`${API_BASE}/courses/${productId}/available-weeks?num_weeks=8`);
      if (!response.ok) throw new Error('Failed to load weeks');

      const weeks = await response.json();
      renderWeeks(weeks);
      enrollmentForm.style.display = 'block';
    } catch (err) {
      weekSelector.innerHTML = '<div class="error-text">Failed to load available weeks. Please refresh.</div>';
      console.error(err);
    }
  }

  function renderWeeks(weeks) {
    weekSelector.classList.remove('loading');

    const availableWeeks = weeks.filter(w => w.is_available);

    if (availableWeeks.length === 0) {
      weekSelector.innerHTML = '<div class="no-weeks">No available weeks at this time. Please check back later.</div>';
      return;
    }

    // Only show weeks that have spots available (hide full weeks entirely)
    const openWeeks = availableWeeks.filter(w => !w.is_full);

    if (openWeeks.length === 0) {
      weekSelector.innerHTML = '<div class="no-weeks">No available weeks at this time. Please check back later.</div>';
      return;
    }

    weekSelector.innerHTML = openWeeks.map(week => `
      <div class="week-option"
           data-year="${week.year}"
           data-week="${week.week_number}">
        <div class="week-date">${week.course_dates_display}</div>
      </div>
    `).join('');

    // Add click handlers
    weekSelector.querySelectorAll('.week-option:not([data-disabled])').forEach(option => {
      option.addEventListener('click', () => selectWeek(option));
    });
  }

  function selectWeek(option) {
    // Remove previous selection
    weekSelector.querySelectorAll('.week-option').forEach(o => o.classList.remove('selected'));

    // Select new week
    option.classList.add('selected');
    selectedWeek = {
      year: parseInt(option.dataset.year),
      week_number: parseInt(option.dataset.week)
    };

    enrollButton.disabled = false;
    enrollButton.textContent = 'Proceed to Checkout →';
  }

  // Handle enrollment
  enrollButton.addEventListener('click', async () => {
    const name = document.getElementById('student-name').value.trim();
    const email = document.getElementById('student-email').value.trim();

    if (!name || !email) {
      showError('Please enter your name and email.');
      return;
    }

    if (!selectedWeek) {
      showError('Please select a week.');
      return;
    }

    enrollButton.disabled = true;
    enrollButton.textContent = 'Creating checkout...';
    errorDiv.style.display = 'none';

    try {
      // Step 1: Create reservation
      const reserveResponse = await fetch(`${API_BASE}/checkout/reserve`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          product_id: productId,
          year: selectedWeek.year,
          week_number: selectedWeek.week_number,
          email: email
        })
      });

      if (!reserveResponse.ok) {
        const err = await reserveResponse.json();
        throw new Error(err.detail || 'Failed to reserve spot');
      }

      const reservation = await reserveResponse.json();
      reservationToken = reservation.reservation_token;

      // Step 2: Create Stripe checkout session
      const sessionResponse = await fetch(`${API_BASE}/checkout/create-session`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          product_id: productId,
          year: selectedWeek.year,
          week_number: selectedWeek.week_number,
          email: email,
          name: name,
          reservation_token: reservationToken
        })
      });

      if (!sessionResponse.ok) {
        const err = await sessionResponse.json();
        throw new Error(err.detail || 'Failed to create checkout');
      }

      const session = await sessionResponse.json();

      // Redirect to Stripe checkout
      window.location.href = session.checkout_url;

    } catch (err) {
      showError(err.message);
      enrollButton.disabled = false;
      enrollButton.textContent = 'Proceed to Checkout →';
    }
  });

  function showError(message) {
    errorDiv.textContent = message;
    errorDiv.style.display = 'block';
  }

  // Initialize
  loadAvailableWeeks();
})();
</script>
{{ end }}